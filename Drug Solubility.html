<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>All-in-One Formulation & Pre-formulation Profiler</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-main: #f5f3ff; /* violet-50 */
            --bg-section: #ede9fe; /* violet-100 */
            --text-primary: #5b21b6; /* violet-800 */
            --text-secondary: #7c3aed; /* violet-600 */
            --accent-primary: #d946ef; /* fuchsia-500 */
            --accent-secondary: #c026d3; /* fuchsia-600 */
            --border-light: #ddd6fe; /* violet-200 */
            --border-medium: #c4b5fd; /* violet-300 */
        }

        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 25px;
            background-color: var(--bg-main);
            color: var(--text-primary);
            line-height: 1.7;
            font-size: 16px
        }

        .container {
            max-width: 1200px;
            margin: 25px auto;
            background: #fff;
            padding: 35px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, .07)
        }
        
        #home-screen {
            min-height: 80vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        h1,
        h2,
        h3,
        h4 {
            text-align: center;
            color: var(--text-primary);
            margin-bottom: 30px;
            font-weight: 700
        }

        h1 {
            font-size: 2.8em
        }

        h2 {
            font-size: 2em;
            text-align: left;
            margin-top: 35px
        }

        h3 {
            font-size: 1.6em
        }

        h4 {
            font-size: 1.2em;
            text-align: left;
            margin-bottom: 15px;
            color: var(--text-secondary);
        }

        .section {
            background-color: var(--bg-section);
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            border-left: 7px solid var(--accent-primary);
            box-shadow: 0 3px 12px rgba(0, 0, 0, .05)
        }

        label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: #581c87; /* purple-900 */
            font-size: 1.05em
        }

        input[type=text],
        input[type=number],
        select,
        textarea {
            width: 100%;
            padding: 12px 15px;
            margin-bottom: 18px;
            border: 1px solid var(--border-medium);
            border-radius: 8px;
            box-sizing: border-box;
            transition: border-color .3s ease, box-shadow .3s ease, background-color .3s ease;
            background-color: #fff;
            font-size: 1em
        }

        input[type=text]:focus,
        input[type=number]:focus,
        select:focus,
        textarea:focus {
            border-color: var(--accent-secondary);
            box-shadow: 0 0 0 4px rgba(217, 70, 239, .3);
            outline: none;
            background-color: #faf5ff; /* purple-50 */
        }

        input[readonly] {
            background-color: #f3f4f6; /* gray-100 */
            cursor: not-allowed
        }

        button {
            background-color: var(--text-secondary);
            color: #fff;
            padding: 14px 25px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 600;
            margin-top: 20px;
            transition: background-color .2s ease, transform .1s ease, box-shadow .2s ease;
            box-shadow: 0 5px 15px rgba(124, 58, 237, .3)
        }

        button:hover {
            background-color: var(--text-primary);
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(124, 58, 237, .4)
        }

        button:active {
            transform: translateY(0);
            box-shadow: 0 3px 8px rgba(124, 58, 237, .2)
        }

        .btn-secondary {
            background-color: var(--accent-primary);
            box-shadow: 0 5px 15px rgba(217, 70, 239, .3)
        }

        .btn-secondary:hover {
            background-color: var(--accent-secondary);
            box-shadow: 0 8px 20px rgba(217, 70, 239, .4)
        }
        
        .btn-small {
            padding: 8px 12px;
            font-size: 0.9em;
            margin-top: 0;
            margin-left: 10px;
        }

        .btn-danger {
            background-color: #ef4444;
            box-shadow: 0 5px 15px rgba(239, 68, 68, .3)
        }

        .btn-danger:hover {
            background-color: #dc2626;
            box-shadow: 0 8px 20px rgba(239, 68, 68, .4)
        }

        .half-width {
            width: calc(50% - 20px);
            float: left;
            margin-right: 40px
        }

        .half-width:last-child {
            margin-right: 0
        }
        
        .third-width {
            width: calc(33.33% - 20px);
            float: left;
            margin-right: 30px;
        }
        .third-width:last-child {
            margin-right: 0;
        }

        .clearfix::after {
            content: "";
            clear: both;
            display: table
        }

        #detectionStatus {
            padding: 15px;
            margin-top: 20px;
            border-radius: 10px;
            font-weight: 600;
            font-size: .95em
        }

        .status-success {
            background-color: #dcfce7; /* green-100 */
            color: #166534; /* green-800 */
            border: 1px solid #86efac; /* green-300 */
        }

        .status-warning {
            background-color: #fef3c7; /* amber-100 */
            color: #92400e; /* amber-800 */
            border: 1px solid #fcd34d; /* amber-300 */
        }

        .status-error {
            background-color: #fee2e2; /* red-100 */
            color: #991b1b; /* red-800 */
            border: 1px solid #fca5a5; /* red-300 */
        }

        .solvent-card {
            background: #fff;
            border: 1px solid var(--border-light);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, .05);
            transition: transform .2s ease, box-shadow .2s ease;
            display: flex;
            flex-direction: column;
            cursor: pointer;
        }

        .solvent-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, .1)
        }

        .solvent-card.best {
            border-color: #10b981; /* emerald-500 */
        }

        .solvent-card.super-best {
            border-color: var(--accent-primary);
            box-shadow: 0 8px 25px rgba(217, 70, 239, .3);
        }

        #solventCards {
            margin-top: 30px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 25px
        }

        #chart {
            min-height: 450px;
            margin-top: 35px;
            border: 1px solid var(--border-light);
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, .05);
            background-color: #fff
        }

        .custom-solvent-item {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px
        }

        .custom-solvent-item input {
            flex: 1;
            margin-bottom: 0
        }

        .drug-buttons button {
            margin-right: 10px;
            margin-bottom: 10px;
            padding: 10px 18px;
            font-size: .95em;
            background-color: #c4b5fd; /* violet-300 */
            color: var(--text-primary);
            box-shadow: none;
            border-radius: 6px
        }

        .drug-buttons button:hover {
            background-color: #a78bfa; /* violet-400 */
            transform: translateY(-2px)
        }

        .slider-container {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px
        }

        .slider {
            flex: 1;
            height: 8px;
            background: var(--border-light);
            border-radius: 4px;
            -webkit-appearance: none;
            appearance: none;
            outline: none
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--text-secondary);
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0, 0, 0, .2);
            transition: background-color .2s ease, box-shadow .2s ease
        }

        .slider::-webkit-slider-thumb:hover {
            background: var(--text-primary);
            box-shadow: 0 3px 8px rgba(0, 0, 0, .3)
        }

        .slider-value {
            min-width: 80px;
            text-align: center;
            font-weight: 600;
            color: var(--text-secondary);
            background-color: #ede9fe; /* violet-100 */
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 1.05em
        }

        select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%237c3aed' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1.5em;
            padding-right: 2.5rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, .05)
        }
        
        .db-links-container {
            background-color: #ede9fe; /* violet-100 */
            border: 1px solid #ddd6fe; /* violet-200 */
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .db-links-container p {
            margin: 0;
            padding: 5px 0;
        }
        
        .db-link {
            color: var(--text-secondary);
            font-weight: 600;
            text-decoration: none;
            margin: 0 5px;
            transition: color 0.2s;
        }
        .db-link:hover {
            color: var(--text-primary);
            text-decoration: underline;
        }
        .db-note {
            font-size: 0.85em;
            color: #6d28d9; /* violet-700 */
            margin-top: 10px;
        }

        .gauge-bar-bg {
            background-color: var(--border-light);
            border-radius: 9999px;
            overflow: hidden;
            height: 1rem;
            width: 100%;
        }
        .gauge-bar {
            height: 100%;
            border-radius: 9999px;
            transition: width 0.5s ease-in-out;
        }
        
        .pathway-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 5px solid;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        .pathway-card pre {
            background-color: #f5f3ff; /* violet-50 */
            border: 1px solid #ddd6fe; /* violet-200 */
            padding: 15px;
            border-radius: 8px;
            font-size: 0.9em;
            white-space: pre-wrap;
            word-wrap: break-word;
            color: #3730a3; /* indigo-800 */
        }
        .pathway-card .impurity-structure {
            border: 1px solid var(--border-light);
            border-radius: 8px;
            margin-top: 10px;
            padding: 10px;
            background-color: #fff;
        }
        .deep-dive {
            background-color: #faf5ff; /* purple-50 */
            border: 1px solid var(--border-medium);
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            font-size: 0.9em;
        }
        .deep-dive h5 {
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
            text-align: left;
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-overlay.visible {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transform: scale(0.95);
            transition: transform 0.3s ease;
        }
        .modal-overlay.visible .modal-content {
            transform: scale(1);
        }
        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: #e2e8f0;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-weight: bold;
        }
        .formula {
            background-color: #f1f5f9;
            padding: 10px 15px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 1.1em;
            color: #1e293b;
            text-align: center;
            margin: 10px 0;
        }
        
        /* Tab Styles */
        .tab-container {
            display: flex;
            border-bottom: 2px solid var(--border-medium);
            margin-bottom: 25px;
        }
        .tab-button {
            padding: 12px 20px;
            cursor: pointer;
            border: none;
            background-color: transparent;
            font-size: 1.1em;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: -2px;
            border-bottom: 3px solid transparent;
            transition: color 0.3s ease, border-color 0.3s ease;
        }
        .tab-button.active {
            color: var(--text-primary);
            border-bottom-color: var(--text-primary);
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        
        .recommendation-card {
            background-color: #fff;
            border: 1px solid var(--border-light);
            border-radius: 12px;
            padding: 25px;
            margin-top: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }
        .recommendation-card h4 {
            color: var(--text-primary);
            margin-top: 0;
            margin-bottom: 15px;
        }
        .recommendation-card ul {
            list-style-type: '✓  ';
            padding-left: 20px;
            color: #64748b; /* slate-500 */
        }
         .recommendation-card ul li {
            margin-bottom: 8px;
         }
        .recommendation-card .risk-high {
            color: #b91c1c; /* red-700 */
            font-weight: 600;
        }
        .recommendation-card .risk-medium {
            color: #b45309; /* amber-700 */
            font-weight: 600;
        }
        .recommendation-card .risk-low {
            color: #15803d; /* green-700 */
            font-weight: 600;
        }
        .excipient-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
        }
        .excipient-grid label {
            display: flex;
            align-items: center;
            background-color: #fff;
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid var(--border-light);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .excipient-grid label:hover {
            border-color: var(--accent-secondary);
            background-color: #faf5ff;
        }
        .excipient-grid input {
            margin-right: 8px;
            width: auto;
            margin-bottom: 0;
        }


        @media print {
            body {
                padding: 0;
                margin: 0;
                background-color: #fff;
                color: #000;
            }
            #home-screen, #back-to-home-btn, .tab-container, button, #launch-profiler-btn {
                display: none !important;
            }
            .container {
                box-shadow: none;
                border: none;
                padding: 20px;
                margin: 0;
                max-width: 100%;
            }
            .section, .recommendation-card {
                box-shadow: none;
                border: 1px solid #ccc;
                padding: 15px;
                background-color: #fff !important;
            }
            .tab-content {
                display: block !important;
            }
            h1, h2, h3, h4 {
                color: #000;
            }
            @page {
                size: A4;
                margin: 1cm;
            }
        }

        @media (max-width:768px) {
            body {
                font-size: 15px;
                padding: 15px
            }

            .container {
                padding: 25px;
                margin: 15px auto
            }

            h1 {
                font-size: 2.2em
            }

            h2 {
                font-size: 1.6em
            }

            h3 {
                font-size: 1.3em
            }

            .half-width {
                width: 100%;
                margin-right: 0;
                float: none
            }

            #solventCards {
                grid-template-columns: 1fr
            }

            button {
                padding: 12px 20px;
                font-size: 1em
            }

            .drug-buttons button {
                padding: 8px 12px;
                font-size: .85em
            }
        }
    </style>
</head>

<body>
    <div id="home-screen">
        <div class="container text-center">
            <h1 class="text-4xl md:text-5xl font-bold mb-4">All-in-One Formulation & Pre-formulation Profiler</h1>
            <p class="max-w-3xl mx-auto text-lg text-slate-600 mb-8">
                A comprehensive suite for drug development scientists. Predict physicochemical properties, analyze stability, assess risks, and design robust formulations for any dosage form with this integrated, science-driven tool.
            </p>
            <button id="launch-profiler-btn" class="text-xl px-8 py-4">Launch Profiler</button>
        </div>
    </div>

    <div id="profiler-screen" class="hidden">
        <div class="container">
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-3xl m-0">Formulation Profiler</h1>
                <div>
                    <button id="export-excel-btn" class="text-sm bg-green-100 text-green-700 hover:bg-green-200 font-semibold py-2 px-4 border border-green-500 rounded-lg" style="margin-top: 0; margin-right: 10px;">
                        📄 Export to Excel
                    </button>
                    <button id="print-summary-btn" class="text-sm bg-transparent text-violet-600 hover:text-violet-800 font-semibold py-2 px-4 border border-violet-500 hover:border-violet-700 rounded-lg" style="margin-top: 0; margin-right: 10px;">
                        🖨️ Print Summary
                    </button>
                    <button id="back-to-home-btn" class="text-sm bg-transparent text-violet-600 hover:text-violet-800 font-semibold py-2 px-4 border border-violet-500 hover:border-violet-700 rounded-lg" style="margin-top: 0;">
                        Back to Home
                    </button>
                </div>
            </div>

            <!-- DRUG INPUT SECTION -->
            <div class="section">
                <h2>Drug Input</h2>
                <label for="productName">Product Name (Optional):</label>
                <input type="text" id="productName" placeholder="Enter product name (e.g., My New Drug Formulation)">
                <label for="smiles">SMILES or Drug Name:</label>
                <textarea id="smiles" rows="2" placeholder="Enter SMILES string (e.g., CC(=O)OC1=CC=CC=C1C(=O)O) or drug name (e.g., aspirin)"></textarea>
                <button class="btn-secondary" onclick="detectDrugProperties()">🔍 Fetch & Predict Properties</button>
                <div id="detectionStatus"></div>
                <div class="drug-buttons" style="margin-top:15px;">
                    <label>Quick Examples:</label><br>
                    <button class="btn" onclick="loadDrug('paclitaxel')">Paclitaxel</button>
                    <button class="btn" onclick="loadDrug('ibuprofen')">Ibuprofen</button>
                    <button class="btn" onclick="loadDrug('metformin')">Metformin</button>
                    <button class="btn" onclick="loadDrug('gemcitabine')">Gemcitabine</button>
                    <button class="btn" onclick="loadDrug('azacitidine')">Azacitidine</button>
                </div>
                <div id="externalLinks" class="db-links-container" style="display: none;">
                    <h4>External Database Links for Deeper Analysis</h4>
                    <p>
                        <a id="pubchemLink" href="#" target="_blank" class="db-link">PubChem</a> |
                        <a id="drugbankLink" href="#" target="_blank" class="db-link">DrugBank</a> |
                        <a id="chemblLink" href="#" target="_blank" class="db-link">ChEMBL</a> |
                        <a id="reaxysLink" href="#" target="_blank" class="db-link">Reaxys</a> |
                        <a id="keggLink" href="#" target="_blank" class="db-link">KEGG</a>
                    </p>
                    <p>
                        <a id="swissadmeLink" href="#" target="_blank" class="db-link">SwissADME</a> |
                        <a id="pkcsmLink" href="#" target="_blank" class="db-link">pkCSM</a>
                        <button class="btn btn-small" onclick="copySmiles()">Copy SMILES</button>
                    </p>
                    <p class="db-note">Note: SwissADME and pkCSM require SMILES input. Use the 'Copy SMILES' button for convenience.</p>
                </div>
            </div>

            <!-- TABS -->
            <div class="tab-container">
                <button class="tab-button active" onclick="openTab(event, 'Preformulation')">🧪 Pre-formulation Analysis</button>
                <button class="tab-button" onclick="openTab(event, 'Formulation')">💊 Formulation Development</button>
            </div>

            <!-- PRE-FORMULATION TAB CONTENT -->
            <div id="Preformulation" class="tab-content active">
                <div class="section clearfix">
                    <h2>Drug Parameters</h2>
                    <div class="half-width">
                        <label>pKa:</label>
                        <input type="number" id="pka" step="0.1" placeholder="Auto-detected or manual">
                        <label>Molecule Type:</label>
                        <select id="molType">
                            <option value="acid">Acid</option>
                            <option value="base">Base</option>
                            <option value="neutral">Neutral</option>
                            <option value="zwitterion">Zwitterion</option>
                        </select>
                        <label>Base Solubility S₀ (mg/mL):</label>
                        <input type="number" id="baseSol" step="0.01" placeholder="Auto-detected or manual">
                         <label>Molar Mass (g/mol):</label>
                        <input type="number" id="molarMass" step="0.1" placeholder="Auto-estimated">
                    </div>
                    <div class="half-width">
                        <label>Log P:</label>
                        <input type="number" id="logP" step="0.1" placeholder="Auto-detected" readonly>
                        <label>Molar Volume (cm³/mol):</label>
                        <input type="number" id="molarVolume" step="0.1" placeholder="Auto-estimated" readonly>
                         <label>Interaction Radius (R₀):</label>
                        <input type="number" id="ra" step="0.1" value="5.0" placeholder="Drug R₀">
                    </div>
                </div>
                 <div class="section clearfix">
                    <h2>Hansen Solubility Parameters (HSP)</h2>
                     <div class="half-width">
                        <label>Drug δD:</label>
                        <input type="number" id="deltaD" step="0.1" placeholder="Auto-detected">
                        <label>Drug δP:</label>
                        <input type="number" id="deltaP" step="0.1" placeholder="Auto-detected">
                     </div>
                     <div class="half-width">
                        <label>Drug δH:</label>
                        <input type="number" id="deltaH" step="0.1" placeholder="Auto-detected">
                        <label>Hildebrand δ (Total):</label>
                        <input type="number" id="deltaTotal" step="0.1" placeholder="Auto-calculated" readonly>
                    </div>
                </div>
                <div class="section">
                    <h2>🌡️ Forced Degradation & Stability Conditions</h2>
                    <p style="font-size: 0.9em; color: #555; margin-top: -15px; margin-bottom: 20px;">Simulate stress conditions based on ICH guidelines. The model uses the <b>Arrhenius equation</b>, <b>pH-rate profiles</b>, and factors for <b>photodegradation</b>, <b>oxidation</b>, and other stress factors.</p>
                    <div class="clearfix">
                        <div class="half-width">
                            <label for="degradationTime">Time (days):</label>
                            <input type="number" id="degradationTime" value="30" step="1" placeholder="e.g., 30">
                            
                            <label for="tempRange">Temperature (°C):</label>
                            <select id="tempRange">
                                <option value="25-40">Standard (25-40°C)</option>
                                <option value="5-15">Refrigerated (5-15°C)</option>
                                <option value="40-65">Accelerated (40-65°C)</option>
                                <option value="65-80">Stress (65-80°C)</option>
                            </select>

                            <label for="phRange">Acid/Alkali Stress (pH):</label>
                            <select id="phRange">
                                <option value="5-7">Neutral (pH 5-7)</option>
                                <option value="3-5">Mild Acid (pH 3-5)</option>
                                <option value="1-3">Strong Acid Stress (pH 1-3)</option>
                                <option value="7-9">Mild Alkali (pH 7-9)</option>
                                <option value="9-11">Alkali Stress (pH 9-11)</option>
                                <option value="11-14">Strong Alkali Stress (pH 11-14)</option>
                            </select>
                        </div>
                        <div class="half-width">
                            <label for="lightExposure">Light Exposure:</label>
                            <select id="lightExposure">
                                <option value="none">None (Protected from Light)</option>
                                <option value="ambient">Ambient Room Light</option>
                                <option value="uv">Direct UV Light (ICH Q1B)</option>
                            </select>
                            
                            <label>Other Stress Factors:</label>
                            <div style="margin-top: 10px;">
                                <input type="checkbox" id="oxidizingAgent" style="width: auto; transform: scale(1.2); cursor: pointer; margin-right: 8px;">
                                <label for="oxidizingAgent" style="display: inline-block; margin-bottom: 0;">Oxidizing Agent Present</label>
                            </div>
                            <div style="margin-top: 10px;">
                                <input type="checkbox" id="metalIons" style="width: auto; transform: scale(1.2); cursor: pointer; margin-right: 8px;">
                                <label for="metalIons" style="display: inline-block; margin-bottom: 0;">Metallic Ion Contamination</label>
                            </div>

                            <label style="margin-top: 20px;">Relative Humidity (RH):</label>
                            <div class="slider-container">
                                <input type="range" id="humiditySlider" class="slider" min="10" max="90" step="5" value="60">
                                <span class="slider-value" id="humidityValue">60% RH</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="section">
                    <h2>Solvent System</h2>
                    <label for="solvents" style="margin-top:15px;">Standard Solvents (multi-select with Ctrl/Cmd):</label>
                    <select id="solvents" multiple style="height:150px;"></select>
                    <div id="customSolventsContainer" style="margin-top:15px;">
                        <label>Custom Solvents (Name, δD, δP, δH):</label>
                        <div class="custom-solvent-item">
                            <input type="text" placeholder="Name" class="custom-name">
                            <input type="number" placeholder="δD" class="custom-dd" step="0.1">
                            <input type="number" placeholder="δP" class="custom-dp" step="0.1">
                            <input type="number" placeholder="δH" class="custom-dh" step="0.1">
                            <button class="btn-danger" onclick="removeCustomSolvent(this)">-</button>
                        </div>
                    </div>
                    <button class="btn" onclick="addCustomSolvent()">+ Add Custom Solvent</button>
                </div>
                <button onclick="runPreformulationAnalysis()">🚀 Run Pre-formulation Analysis</button>
                <div id="results" style="margin-top:25px;display:none;">
                    <h2>Prediction Results</h2>
                    <div id="bestSolventsRecommendation" class="grid md:grid-cols-2 gap-6 mb-8"></div>
                    <div id="solventCards"></div>
                    
                    <div id="pathwayResults" class="section" style="display:none; margin-top: 30px; border-left-color: var(--accent-primary); background-color: #fdf2f8;">
                        <h3>Degradation Pathway Analysis</h3>
                        <div id="pathwayInfo"></div>
                    </div>

                    <div id="degradationResults" class="section" style="display:none; margin-top: 30px; border-left-color: #ef4444; background-color: #fee2e2;">
                        <h3>Quantitative Degradation Estimate</h3>
                        <p id="degradationInfo"></p>
                    </div>

                    <div id="binaryBlendSuggestion" class="section" style="display:none;">
                        <h3>Optimal Binary Blend Suggestion</h3>
                        <p id="blendResult"></p>
                    </div>
                    <div id="ternaryBlendSuggestion" class="section" style="display:none;">
                        <h3>Optimal Ternary Blend Suggestion</h3>
                        <p id="ternaryBlendResult"></p>
                    </div>
                    <div id="chart"></div>
                </div>
            </div>

            <!-- FORMULATION DEVELOPMENT TAB CONTENT -->
            <div id="Formulation" class="tab-content">
                <div class="section">
                    <h2>💊 Formulation Development Strategy</h2>
                    <p style="font-size: 0.9em; color: #555; margin-top: -15px; margin-bottom: 20px;">
                        Use the data from the pre-formulation analysis to generate a comprehensive formulation strategy, including dosage form selection, excipient compatibility, risk assessment, and process considerations.
                    </p>
                    <label for="highestDose">Highest Anticipated Dose (mg):</label>
                    <input type="number" id="highestDose" placeholder="e.g., 100" value="100">
                    <button onclick="runFormulationAnalysis()">💡 Generate Formulation Strategy</button>
                </div>
                
                <div id="formulation-results" style="display:none;">
                    <!-- BCS & Bioavailability -->
                    <div class="section">
                        <h2>BCS Classification & In-Silico Bioavailability</h2>
                        <div id="bcsPrediction" class="recommendation-card"></div>
                    </div>

                    <!-- Dosage Form Feasibility -->
                    <div class="section">
                        <h2>Dosage Form Feasibility Predictor</h2>
                        <div id="dosageFormRec" class="recommendation-card"></div>
                    </div>

                    <!-- Particle Size & Solid State -->
                    <div class="section">
                        <h2>Particle Size & Solid-State Recommendations</h2>
                        <div id="solidStateRec" class="recommendation-card"></div>
                    </div>

                    <!-- Excipient Compatibility -->
                    <div class="section">
                        <h2>Excipient Compatibility Checker</h2>
                        <div id="excipientRec" class="recommendation-card"></div>
                    </div>
                    
                    <!-- Process & Regulatory -->
                    <div class="section">
                        <h2>Process Parameters & Regulatory Risk Assessment</h2>
                        <div class="grid md:grid-cols-2 gap-6">
                            <div id="processRec" class="recommendation-card"></div>
                            <div id="regulatoryRec" class="recommendation-card"></div>
                        </div>
                    </div>
                    
                    <!-- Injectable-Specific Module (if applicable) -->
                    <div id="injectable-specific-module" class="section" style="display:none;">
                        <h2>💉 Injectable Formulation Deep Dive</h2>
                         <div class="clearfix">
                            <div class="third-width">
                                <label for="drugConcentration">Drug Conc. (mg/mL):</label>
                                <input type="number" id="drugConcentration" placeholder="e.g., 10" value="10">
                            </div>
                             <div class="third-width">
                                <label for="formulationCosolvent">Co-solvent:</label>
                                <select id="formulationCosolvent">
                                    <option value="none">None (Aqueous)</option>
                                    <option value="propyleneglycol">Propylene Glycol</option>
                                    <option value="peg400">PEG 400</option>
                                    <option value="ethanol">Ethanol</option>
                                    <option value="dmso">DMSO</option>
                                    <option value="custom">Custom...</option>
                                </select>
                            </div>
                            <div class="third-width">
                                <label for="cosolventPercent">Co-solvent (% v/v):</label>
                                <input type="number" id="cosolventPercent" value="0" min="0" max="100">
                            </div>
                        </div>
                        <div id="customCosolventContainer" class="hidden mt-2 clearfix">
                            <div class="half-width">
                                <label for="customCosolventName">Custom Co-solvent Name:</label>
                                <input type="text" id="customCosolventName" placeholder="e.g., Solutol HS 15">
                            </div>
                            <div class="half-width">
                                <label for="customCosolventSigma">Interaction Parameter (σ):</label>
                                <input type="number" id="customCosolventSigma" step="0.1" placeholder="e.g., 4.5">
                            </div>
                        </div>
                        <div class="clearfix mt-4">
                            <div class="half-width">
                                <label for="drugVolume">Drug Product Volume (mL):</label>
                                <input type="number" id="drugVolume" value="1">
                            </div>
                            <div class="half-width">
                                <label for="ivBagVolume">IV Bag Volume (mL):</label>
                                <input type="number" id="ivBagVolume" value="100">
                            </div>
                        </div>
                         <div class="mt-4">
                            <label for="ivFluid">Select IV Dilution Fluid:</label>
                            <select id="ivFluid">
                                <option value="saline">0.9% NaCl (Normal Saline, pH ~5.5)</option>
                                <option value="d5w">5% Dextrose in Water (D5W, pH ~4.5)</option>
                                <option value="lrs">Lactated Ringer's Solution (LRS, pH ~6.5)</option>
                                <option value="custom">Custom pH...</option>
                            </select>
                            <div id="customIvPhContainer" class="hidden mt-2">
                                 <label for="customIvPh">Custom IV Fluid pH:</label>
                                 <input type="number" id="customIvPh" step="0.1" value="7.0">
                            </div>
                        </div>
                        <div id="precipitationRiskRec" class="recommendation-card mt-4"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Detailed Justification -->
    <div id="detailsModal" class="modal-overlay" onclick="hideDetails()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div id="modalContent"></div>
            <div class="modal-close" onclick="hideDetails()">×</div>
        </div>
    </div>

    <div style="text-align:center;margin-top:40px;font-size:0.9em;color:#78716c;">&copy; 2023 All rights reserved to minakshisahoo001@gmail.com</div>
    
    <script>
        const solvents = {
            water: { name: 'Water', dD: 15.5, dP: 16, dH: 42.3, molarVolume: 18, type: 'aqueous' },
            ethanol: { name: 'Ethanol', dD: 15.8, dP: 8.8, dH: 19.4, molarVolume: 58.5, type: 'cosolvent' },
            methanol: { name: 'Methanol', dD: 14.7, dP: 12.3, dH: 22.3, molarVolume: 40.6, type: 'organic' },
            dmso: { name: 'DMSO', dD: 18.4, dP: 16.4, dH: 10.2, molarVolume: 71.3, type: 'cosolvent' },
            peg400: { name: 'PEG-400', dD: 17, dP: 9, dH: 23, molarVolume: 400, type: 'cosolvent' },
            propyleneglycol: { name: 'Propylene Glycol', dD: 16.8, dP: 9.4, dH: 23.3, molarVolume: 73, type: 'cosolvent' },
            glycerin: { name: 'Glycerin', dD: 17.4, dP: 12.1, dH: 29.3, molarVolume: 73.4, type: 'cosolvent' },
            isopropanol: { name: 'Isopropanol', dD: 15.8, dP: 6.1, dH: 16.4, molarVolume: 76.8, type: 'organic' },
            acetone: { name: 'Acetone', dD: 15.5, dP: 10.4, dH: 7, molarVolume: 74, type: 'organic' },
            ethylacetate: { name: 'Ethyl Acetate', dD: 15.8, dP: 5.3, dH: 7.2, molarVolume: 98.6, type: 'organic' },
            dichloromethane: { name: 'Dichloromethane', dD: 17, dP: 7.3, dH: 7.1, molarVolume: 64.4, type: 'organic' },
            dmf: { name: 'N,N-Dimethylformamide (DMF)', dD: 17.4, dP: 11.3, dH: 7.7, molarVolume: 77, type: 'organic' },
            dma: { name: 'N,N-Dimethylacetamide (DMA)', dD: 16.8, dP: 11.5, dH: 10.2, molarVolume: 93, type: 'cosolvent' },
            nmp: { name: 'N-Methyl-2-pyrrolidone (NMP)', dD: 18, dP: 12.3, dH: 7.2, molarVolume: 96.6, type: 'cosolvent' },
            thf: { name: 'Tetrahydrofuran (THF)', dD: 16.8, dP: 5.7, dH: 8, molarVolume: 81.9, type: 'organic' },
            toluene: { name: 'Toluene', dD: 18, dP: 1.4, dH: 2, molarVolume: 106.6, type: 'organic' },
            acetonitrile: { name: 'Acetonitrile', dD: 15.3, dP: 18, dH: 6.1, molarVolume: 52.9, type: 'organic' },
            hexane: { name: 'Hexane', dD: 14.9, dP: 0, dH: 0, molarVolume: 131.6, type: 'organic' },
            chloroform: { name: 'Chloroform', dD: 17.8, dP: 3.1, dH: 5.7, molarVolume: 80.7, type: 'organic' },
            dioxane: { name: '1,4-Dioxane', dD: 17.5, dP: 1.8, dH: 9, molarVolume: 85.7, type: 'organic' },
            triethyleneglycol: { name: 'Triethylene Glycol', dD: 16.1, dP: 8.8, dH: 16.7, molarVolume: 139.1, type: 'cosolvent' },
            tween80: { name: 'Tween 80', dD: 16.5, dP: 8.5, dH: 15, molarVolume: 1310, type: 'surfactant' },
            cremophor: { name: 'Cremophor EL', dD: 16.2, dP: 7.8, dH: 12.5, molarVolume: 850, type: 'surfactant' },
            benzylalcohol: { name: 'Benzyl Alcohol', dD: 18.4, dP: 6.3, dH: 13.7, molarVolume: 104.8, type: 'cosolvent' },
            benzylbenzoate: { name: 'Benzyl Benzoate', dD: 19, dP: 4, dH: 5, molarVolume: 208.2, type: 'organic' },
            peg300: { name: 'PEG-300', dD: 17, dP: 9, dH: 23, molarVolume: 300, type: 'cosolvent' },
            tba: { name: 'tert-Butyl Alcohol (TBA)', dD: 15.8, dP: 4.5, dH: 13, molarVolume: 92.4, type: 'organic' },
            mct: { name: 'Medium-Chain Triglycerides (MCT)', dD: 16, dP: 2, dH: 2, molarVolume: 350, type: 'oil' },
            castoroil: { name: 'Castor Oil', dD: 17, dP: 5, dH: 9, molarVolume: 900, type: 'oil' },
            aceticacid: { name: 'Acetic Acid', dD: 14.5, dP: 8, dH: 13.5, molarVolume: 60.0, type: 'aqueous' },
        };
        const drugDatabase = {
            aspirin: { name: 'Aspirin', smiles: 'CC(=O)OC1=CC=CC=C1C(=O)O', pka: 3.5, type: 'acid', baseSol: 3.3, logP: 1.19, molarMass: 180.16, hansenParams: { dD: 18.4, dP: 8.2, dH: 10.5 }, molarVolume: 138.1 },
            ibuprofen: { name: 'Ibuprofen', smiles: 'CC(C)CC1=CC=C(C=C1)C(C)C(=O)O', pka: 4.4, type: 'acid', baseSol: .021, logP: 3.97, molarMass: 206.29, hansenParams: { dD: 17.8, dP: 6.5, dH: 8.2 }, molarVolume: 211.3 },
            caffeine: { name: 'Caffeine', smiles: 'CN1C=NC2=C1C(=O)N(C(=O)N2C)C', pka: 10.4, type: 'base', baseSol: 21.6, logP: -.07, molarMass: 194.19, hansenParams: { dD: 19.2, dP: 11.8, dH: 15.3 }, molarVolume: 178.2 },
            paracetamol: { name: 'Paracetamol', smiles: 'CC(=O)NC1=CC=C(C=C1)O', pka: 9.38, type: 'neutral', baseSol: 14, logP: .46, molarMass: 151.16, hansenParams: { dD: 18.6, dP: 10.4, dH: 16.8 }, molarVolume: 140.1 },
            warfarin: { name: 'Warfarin', smiles: 'CC(=O)CC(C1=CC=CC=C1)C2=C(C3=CC=CC=C3OC2=O)O', pka: 5.1, type: 'acid', baseSol: .017, logP: 2.7, molarMass: 308.33, hansenParams: { dD: 19.1, dP: 9.2, dH: 11.4 }, molarVolume: 308.3 },
            metformin: { name: 'Metformin', smiles: 'CN(C)C(=N)NC(=N)N', pka: 12.4, type: 'base', baseSol: 300, logP: -2.64, molarMass: 129.16, hansenParams: { dD: 16.8, dP: 14.2, dH: 22.5 }, molarVolume: 129.2 },
            paclitaxel: { name: 'Paclitaxel', smiles: 'CC(=O)OC(C(C1(C(C(C2=C(C1)C(C(C3(C(C2O)CC(C(C3(C)C)C(=O)C(C(C4=CC=CC=C4)NC(=O)C5=CC=CC=C5)C(=O)O6)O)OC6=O)O)OC(=O)C7=CC=CC=C7)C)O)C)C)C', pka: 10.5, type: 'neutral', baseSol: .0004, logP: 3.96, molarMass: 853.9, hansenParams: { dD: 19.5, dP: 7, dH: 9 }, molarVolume: 853.9 },
            decitabine: { name: 'Decitabine', smiles: 'C1C(C(C(N1C2=NC(=O)N=C(N2)N)O)O)CO', pka: 4.4, type: 'base', baseSol: 10, logP: -1.5, molarMass: 228.21, hansenParams: { dD: 16, dP: 12, dH: 25 }, molarVolume: 228.2 },
            azacitidine: { name: 'Azacitidine', smiles: 'NC1=NC(=O)N=C(N1)C2C(C(C(O2)CO)O)O', pka: 4.6, type: 'base', baseSol: 50, logP: -1, molarMass: 244.2, hansenParams: { dD: 15.8, dP: 15.0, dH: 40.0 }, molarVolume: 244.2 },
            gemcitabine: { name: 'Gemcitabine', smiles: 'C1=CN(C(=O)N=C1N)[C@H]2C([C@@H]([C@H](O2)CO)O)(F)F', pka: 3.6, type: 'base', baseSol: 15.3, logP: -1.4, molarMass: 263.2, hansenParams: { dD: 16.5, dP: 13.0, dH: 24.0 }, molarVolume: 247.0 },
            leucovorin: { name: 'Leucovorin', smiles: 'C1C(N(C2=C(N1)N=C(NC2=O)N)C=O)CNC3=CC=C(C=C3)C(=O)N[C@@H](CCC(=O)O)C(=O)O', pka: 3.1, type: 'acid', baseSol: 0.4, logP: -1.8, molarMass: 471.5, hansenParams: { dD: 19.0, dP: 14.0, dH: 18.0 }, molarVolume: 454.0 }
        };
        const cosolventData = {
            propyleneglycol: { sigma: 3.5 },
            peg400: { sigma: 5.0 },
            ethanol: { sigma: 4.0 },
            dmso: { sigma: 4.5 }
        };
        
        let fullResults = [];
        let structuralAnalysisResult = {};
        
        document.getElementById('humiditySlider').oninput = function() {
            document.getElementById('humidityValue').textContent = this.value + '% RH';
        };

        document.addEventListener('DOMContentLoaded', () => {
            const sS = document.getElementById('solvents');
            for (const k in solvents) {
                const opt = document.createElement('option');
                opt.value = k;
                opt.textContent = solvents[k].name;
                sS.appendChild(opt)
            }
            document.getElementById('launch-profiler-btn').addEventListener('click', () => {
                document.getElementById('home-screen').style.display = 'none';
                document.getElementById('profiler-screen').style.display = 'block';
            });
            document.getElementById('back-to-home-btn').addEventListener('click', () => {
                document.getElementById('profiler-screen').style.display = 'none';
                document.getElementById('home-screen').style.display = 'block';
            });
            document.getElementById('print-summary-btn').addEventListener('click', () => {
                window.print();
            });
            document.getElementById('export-excel-btn').addEventListener('click', exportToExcel);
            
            document.getElementById('ivFluid').addEventListener('change', function() {
                const customContainer = document.getElementById('customIvPhContainer');
                if (this.value === 'custom') {
                    customContainer.classList.remove('hidden');
                } else {
                    customContainer.classList.add('hidden');
                }
                predictPrecipitationRisk();
            });

            document.getElementById('formulationCosolvent').addEventListener('change', function() {
                const customContainer = document.getElementById('customCosolventContainer');
                if (this.value === 'custom') {
                    customContainer.classList.remove('hidden');
                } else {
                    customContainer.classList.add('hidden');
                }
                predictPrecipitationRisk();
            });

            // Add event listeners for all injectable inputs
            ['drugConcentration', 'formulationCosolvent', 'cosolventPercent', 'drugVolume', 'ivBagVolume', 'customIvPh', 'customCosolventSigma'].forEach(id => {
                const el = document.getElementById(id);
                if(el) el.addEventListener('input', predictPrecipitationRisk);
            });
        });

        function openTab(evt, tabName) {
            var i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tab-content");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }
            tablinks = document.getElementsByClassName("tab-button");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }
            document.getElementById(tabName).style.display = "block";
            evt.currentTarget.className += " active";
        }

        function calcHansenDist(d1, p1, h1, d2, p2, h2) {
            return Math.sqrt(4 * Math.pow(d1 - d2, 2) + Math.pow(p1 - p2, 2) + Math.pow(h1 - h2, 2))
        }

        function calcHildebrandDelta(dD, dP, dH) {
            return Math.sqrt(Math.pow(dD, 2) + Math.pow(dP, 2) + Math.pow(dH, 2))
        }

        function calcHildebrandDiff(drugTotal, solvTotal) {
            return Math.abs(drugTotal - solvTotal)
        }

        function calcPkaPhSol(s0, pKa, pH, molType) {
            if (isNaN(s0) || s0 <= 0) return 0.0001; // Return a very small number to avoid log(0)
            if (molType === 'acid') return s0 * (1 + Math.pow(10, pH - pKa));
            if (molType === 'base') return s0 * (1 + Math.pow(10, pKa - pH));
            return s0
        }

        function loadDrug(dK) {
            const d = drugDatabase[dK];
            if (d) {
                document.getElementById('smiles').value = d.smiles;
                document.getElementById('pka').value = d.pka;
                document.getElementById('molType').value = d.type;
                document.getElementById('baseSol').value = d.baseSol;
                document.getElementById('logP').value = d.logP;
                document.getElementById('molarVolume').value = d.molarVolume;
                document.getElementById('molarMass').value = d.molarMass;
                document.getElementById('deltaD').value = d.hansenParams.dD;
                document.getElementById('deltaP').value = d.hansenParams.dP;
                document.getElementById('deltaH').value = d.hansenParams.dH;
                updateHildebrandFromHansen();
                showDetStat(`Loaded "${d.name}" properties from database.`, 'success');
                updateExternalLinks(d.name, d.smiles);
            } else {
                showDetStat(`Drug "${dK}" not found in database.`, 'error');
                updateExternalLinks(null, null);
            }
        }

        function detectDrugProperties() {
            const inp = document.getElementById('smiles').value.trim();
            if (!inp) {
                showDetStat('Please enter a SMILES string or drug name.', 'warning');
                return
            }
            for (const k in drugDatabase) {
                if (drugDatabase[k].name.toLowerCase() === inp.toLowerCase() || k === inp.toLowerCase()) {
                    loadDrug(k);
                    return
                }
            }
            if (inp.length > 5 && (inp.includes('=') || inp.includes('C') || inp.includes('c') || inp.includes('N') || inp.includes('O'))) {
                try {
                    const cC = (inp.match(/[cC]/g) || []).length;
                    const oC = (inp.match(/[oO]/g) || []).length;
                    const nC = (inp.match(/[nN]/g) || []).length;
                    const sC = (inp.match(/[sS]/g) || []).length;
                    const hC = (inp.match(/[fF]|[cC][lL]|[bB][rR]|[iI]/g) || []).length;
                    const pC = (inp.match(/[pP]/g) || []).length;

                    let eD = 16 + .08 * cC + .5 * hC;
                    let eP = 4 + 1.2 * oC + 1 * nC + .7 * sC;
                    let eH = 5 + 2 * oC + 1.5 * nC;
                    let epKa = 7;
                    let eT = 'neutral';
                    if (inp.includes('C(=O)O') || inp.includes('c1ccccc1S(=O)(=O)O')) {
                        epKa = 4.5;
                        eT = 'acid'
                    } else if (inp.includes('N') && !inp.includes('C(=O)N') && !inp.includes('S(=O)(=O)N')) {
                        epKa = 9.5;
                        eT = 'base'
                    }
                    let eLp = .15 * cC - .2 * oC - .3 * nC + .1 * hC;
                    let eMv = 15 * cC + 10 * oC + 12 * nC + 18 * hC;
                    let eMM = 12.01 * cC + 16.00 * oC + 14.01 * nC + 32.07 * sC + 30.97 * pC + 1.008 * ((inp.match(/[hH]/g) || []).length) + 35.45 * ((inp.match(/Cl/g) || []).length);
                    let eBs = Math.pow(10, -(.5 * eLp + Math.abs(epKa - 7) * .1)) * 100;
                    eD = isNaN(eD) ? 18 : eD;
                    eP = isNaN(eP) ? 10 : eP;
                    eH = isNaN(eH) ? 15 : eH;
                    epKa = isNaN(epKa) ? 7 : epKa;
                    eLp = isNaN(eLp) ? 0 : eLp;
                    eMv = isNaN(eMv) || eMv <= 0 ? 150 : eMv;
                    eMM = isNaN(eMM) || eMM <= 0 ? 300 : eMM;
                    eBs = isNaN(eBs) || eBs <= 0 ? 1 : eBs;
                    document.getElementById('pka').value = epKa.toFixed(1);
                    document.getElementById('molType').value = eT;
                    document.getElementById('baseSol').value = eBs.toFixed(3);
                    document.getElementById('logP').value = eLp.toFixed(2);
                    document.getElementById('molarVolume').value = eMv.toFixed(1);
                    document.getElementById('molarMass').value = eMM.toFixed(2);
                    document.getElementById('deltaD').value = eD.toFixed(1);
                    document.getElementById('deltaP').value = eP.toFixed(1);
                    document.getElementById('deltaH').value = eH.toFixed(1);
                    updateHildebrandFromHansen();
                    showDetStat('Properties estimated locally from SMILES. Please verify for accuracy.', 'warning');
                    updateExternalLinks(null, inp);
                } catch (e) {
                    showDetStat('Error parsing or estimating from SMILES. Please check format or manually input parameters.', 'error');
                    updateExternalLinks(null, null);
                }
            } else {
                showDetStat('Drug not found in local database. Please enter a valid SMILES string or manually input parameters.', 'warning');
                updateExternalLinks(inp, null);
            }
        }

        function updateHildebrandFromHansen() {
            const dD = parseFloat(document.getElementById('deltaD').value) || 0;
            const dP = parseFloat(document.getElementById('deltaP').value) || 0;
            const dH = parseFloat(document.getElementById('deltaH').value) || 0;
            const dT = Math.sqrt(dD * dD + dP * dP + dH * dH);
            document.getElementById('deltaTotal').value = dT.toFixed(1)
        }

        function showDetStat(msg, type) {
            const sD = document.getElementById('detectionStatus');
            sD.className = `status-${type}`;
            sD.textContent = msg
        }

        function copySmiles() {
            const smilesTextarea = document.getElementById('smiles');
            const smilesText = smilesTextarea.value;
            if (smilesText) {
                smilesTextarea.select();
                smilesTextarea.setSelectionRange(0, 99999);
                try {
                    const successful = document.execCommand('copy');
                    const msg = successful ? 'SMILES copied to clipboard!' : 'Failed to copy SMILES.';
                    const status = successful ? 'success' : 'error';
                    showDetStat(msg, status);
                } catch (err) {
                    showDetStat('Failed to copy SMILES.', 'error');
                }
                window.getSelection().removeAllRanges();
            } else {
                showDetStat('No SMILES string to copy.', 'warning');
            }
        }

        function updateExternalLinks(drugName, smiles) {
            const linksContainer = document.getElementById('externalLinks');
            const query = drugName || smiles;
            if (!query) {
                linksContainer.style.display = 'none';
                return;
            }
            
            const encodedQuery = encodeURIComponent(query);

            document.getElementById('pubchemLink').href = `https://pubchem.ncbi.nlm.nih.gov/search/#query=${encodedQuery}`;
            document.getElementById('chemblLink').href = `https://www.ebi.ac.uk/chembl/g/#search_results/all/query=${encodedQuery}`;
            document.getElementById('reaxysLink').href = `https://www.reaxys.com/reaxys/secured/search.do?query=${encodedQuery}`;
            document.getElementById('keggLink').href = `https://www.genome.jp/dbget-bin/www_bfind_sub?mode=bfind&keywords=${encodedQuery}`;
            
            document.getElementById('swissadmeLink').href = 'http://www.swissadme.ch/';
            document.getElementById('pkcsmLink').href = 'http://biosig.unimelb.edu.au/pkcsm/prediction';

            const drugbankLink = document.getElementById('drugbankLink');
            if (drugName) {
                drugbankLink.href = `https://go.drugbank.com/unearth/q?query=${encodeURIComponent(drugName)}`;
                drugbankLink.style.display = 'inline';
            } else {
                drugbankLink.style.display = 'none';
            }
            
            linksContainer.style.display = 'block';
        }

        function addCustomSolvent() {
            const c = document.getElementById('customSolventsContainer');
            const nD = document.createElement('div');
            nD.className = 'custom-solvent-item';
            nD.innerHTML = `<input type="text" placeholder="Name" class="custom-name"><input type="number" placeholder="δD" class="custom-dd" step="0.1"><input type="number" placeholder="δP" class="custom-dp" step="0.1"><input type="number" placeholder="δH" class="custom-dh" step="0.1"><button class="btn-danger" onclick="removeCustomSolvent(this)">-</button>`;
            c.appendChild(nD)
        }

        function removeCustomSolvent(btn) {
            btn.parentElement.remove()
        }
        
        function analyzeStructureForDegradation(smiles) {
            const structuralAlerts = {
                'Hydrolysis': {
                    'Ester': { 
                        pattern: /C\(=O\)O[C|c]/, 
                        products: 'Carboxylic Acid + Alcohol', 
                        risk: 1.5, 
                        reaction: "R-C(=O)O-R' + H₂O → R-COOH + R'-OH", 
                        impurityImg: 'https://placehold.co/400x100/e9d5ff/4c1d95?text=Ester+Hydrolysis+Diagram',
                        deepDive: "<h5>Mechanism & Mitigation</h5><p>Esters are highly susceptible to both acid and base-catalyzed hydrolysis. The reaction rate is typically lowest at pH 3-5. <b>Mitigation:</b> Formulate at the pH of maximum stability, reduce water activity (lyophilization, co-solvents), or use a more stable pro-drug if possible.</p>"
                    },
                    'Amide': { 
                        pattern: /C\(=O\)N/, 
                        products: 'Carboxylic Acid + Amine', 
                        risk: 1.2, 
                        reaction: "R-C(=O)NH-R' + H₂O → R-COOH + R'-NH₂", 
                        impurityImg: 'https://placehold.co/400x100/e9d5ff/4c1d95?text=Amide+Hydrolysis+Diagram',
                        deepDive: "<h5>Mechanism & Mitigation</h5><p>Amides are generally more stable than esters but will still hydrolyze under strong acidic or basic conditions. The reaction is often slower but can be a long-term stability concern, especially at elevated temperatures. <b>Mitigation:</b> Similar to esters, control pH and water activity.</p>"
                    }
                },
                'Oxidation': {
                    'Phenol': { 
                        pattern: /c1((?=.*O))/, 
                        products: 'Quinone-type structures', 
                        risk: 1.4, 
                        reaction: "Ar-OH → O=Ar=O (Quinone)", 
                        impurityImg: 'https://placehold.co/400x100/fee2e2/991b1b?text=Phenol+Oxidation+Diagram',
                        deepDive: "<h5>Mechanism & Mitigation</h5><p>Phenolic moieties are easily oxidized, especially in the presence of trace metal ions (Fe³⁺, Cu²⁺) and light, often forming highly colored quinone impurities. <b>Mitigation:</b> Use antioxidants (e.g., ascorbic acid, sodium metabisulfite), chelating agents (EDTA), and light-protective packaging. Process under a nitrogen blanket.</p>"
                    },
                    'Thioether': { 
                        pattern: /S[C|c]/, 
                        products: 'Sulfoxide, Sulfone', 
                        risk: 1.6, 
                        reaction: "R-S-R' → R-S(=O)-R' → R-S(=O)₂-R'", 
                        impurityImg: 'https://placehold.co/400x100/fee2e2/991b1b?text=Thioether+Oxidation',
                        deepDive: "<h5>Mechanism & Mitigation</h5><p>Thioethers readily oxidize to sulfoxides and then more slowly to sulfones. This is often catalyzed by trace peroxides from excipients (e.g., PEG, Polysorbates). <b>Mitigation:</b> Use low-peroxide grade excipients, add antioxidants, and consider a nitrogen blanket during manufacturing.</p>"
                    }
                },
                'Photodegradation': {
                     'Unsaturated Alkene': { 
                         pattern: /C=C/, 
                         products: 'Epoxides, cleaved products', 
                         risk: 1.1, 
                         reaction: "R-CH=CH-R' + [O] → R-CH(O)CH-R'", 
                         impurityImg: 'https://placehold.co/400x100/fef3c7/92400e?text=Alkene+Photodegradation',
                         deepDive: "<h5>Mechanism & Mitigation</h5><p>Conjugated double bonds can absorb UV/Vis light, leading to excited states that can undergo cis-trans isomerization, cycloaddition, or react with oxygen. <b>Mitigation:</b> Mandatory ICH Q1B photostability testing. Use of amber or opaque primary packaging is essential.</p>"
                    }
                }
            };
            
            const functionalGroups = {
                hasPrimaryAmine: /N([H_]*)C/.test(smiles.replace(/\[nH\]/g, '')) && !/C\(=O\)N/.test(smiles),
                hasSecondaryAmine: /N[H][C|c]/.test(smiles) && !/C\(=O\)N/.test(smiles),
                hasEster: /C\(=O\)O[C|c]/.test(smiles),
                hasAldehyde: /C\(=O\)H/.test(smiles),
                isPhotolabile: /C=C/.test(smiles) || /c[1-6].*[F|Cl|Br|I]/.test(smiles),
                isGenotoxicRisk: /N-N=O/.test(smiles) // Simple N-nitroso check
            };

            const foundPathways = {};
            let totalRiskFactor = 1.0;
            let hasHydrolyticGroup = false;
            let hasOxidativeGroup = false;

            for (const pathway in structuralAlerts) {
                for (const alertName in structuralAlerts[pathway]) {
                    const alert = structuralAlerts[pathway][alertName];
                    if (alert.pattern.test(smiles)) {
                        if (!foundPathways[pathway]) {
                            foundPathways[pathway] = {
                                alerts: [],
                                reactions: [],
                                images: [],
                                deepDives: []
                            };
                        }
                        foundPathways[pathway].alerts.push({ name: alertName, products: alert.products });
                        foundPathways[pathway].reactions.push(alert.reaction);
                        foundPathways[pathway].images.push(alert.impurityImg);
                        foundPathways[pathway].deepDives.push(alert.deepDive);
                        totalRiskFactor *= alert.risk;
                        if (pathway === 'Hydrolysis') hasHydrolyticGroup = true;
                        if (pathway.includes('Oxidation')) hasOxidativeGroup = true;
                    }
                }
            }
            
            return { pathways: foundPathways, riskFactor: totalRiskFactor, hasHydrolyticGroup, hasOxidativeGroup, functionalGroups };
        }

        function calculateDegradation(structuralAnalysis) {
            const timeDays = parseFloat(document.getElementById('degradationTime').value);
            const lightExposure = document.getElementById('lightExposure').value;
            const hasOxidizer = document.getElementById('oxidizingAgent').checked;
            const hasMetalIons = document.getElementById('metalIons').checked;
            const humidity = parseFloat(document.getElementById('humiditySlider').value);
            const logP = parseFloat(document.getElementById('logP').value);
            const molType = document.getElementById('molType').value;

            const phRange = document.getElementById('phRange').value.split('-').map(Number);
            const pH = (phRange[0] + phRange[1]) / 2;

            const tempRange = document.getElementById('tempRange').value.split('-').map(Number);
            const tempC = (tempRange[0] + tempRange[1]) / 2;
            const tempK = tempC + 273.15;

            let k_base = 0.0005 + (Math.abs(logP) * 0.0001);
            k_base *= structuralAnalysis.riskFactor;

            const Ea_assumed = 83140;
            const R = 8.314;
            const T_ref = 298.15;
            const tempFactor = Math.exp((Ea_assumed / R) * (1 / T_ref - 1 / tempK));
            let k_eff = k_base * tempFactor;

            const optimal_pH = (molType === 'acid') ? 4 : (molType === 'base') ? 8 : 7;
            const pH_distance = Math.abs(pH - optimal_pH);
            const stressPhFactor = (pH <= 3 || pH >= 11) ? 2.0 : 1.0;
            const phFactor = Math.pow(1.5, pH_distance) * stressPhFactor;
            k_eff *= phFactor;

            const humidityFactor = structuralAnalysis.hasHydrolyticGroup ? (1 + (humidity / 100)) : 1.0;
            k_eff *= humidityFactor;

            let lightFactor = 1.0;
            if (lightExposure === 'ambient') lightFactor = 2.0;
            else if (lightExposure === 'uv') lightFactor = 10.0;
            k_eff *= lightFactor;
            
            const oxidizerFactor = hasOxidizer ? 5.0 : 1.0;
            k_eff *= oxidizerFactor;

            const metalFactor = (hasMetalIons && structuralAnalysis.hasOxidativeGroup) ? 4.0 : 1.0;
            k_eff *= metalFactor;

            const percentRemaining = 100 * Math.exp(-k_eff * timeDays);
            const percentDegraded = 100 - percentRemaining;

            const resultsDiv = document.getElementById('degradationResults');
            const infoP = document.getElementById('degradationInfo');

            let summary = `After <b>${timeDays} days</b> under specified conditions:<br>`;
            summary += `Predicted Amount Degraded: <b style="color: #991b1b;">${percentDegraded.toFixed(2)}%</b><br>`;
            summary += `Predicted Amount Remaining: <b style="color: #166534;">${percentRemaining.toFixed(2)}%</b><br><br>`;
            summary += `<small><b>Contributing Factors Analysis (based on scientific principles):</b><br>
                - <b>Structural Risk:</b> Vulnerable groups increased base rate by <b>${structuralAnalysis.riskFactor.toFixed(2)}x</b>.<br>
                - <b>Temperature (Arrhenius Law):</b> Rate adjusted by <b>${tempFactor.toFixed(2)}x</b>.<br>
                - <b>pH Stress (pH-Rate Profile):</b> Rate adjusted by <b>${phFactor.toFixed(2)}x</b>.<br>
                - <b>Humidity:</b> Rate adjusted by <b>${humidityFactor.toFixed(2)}x</b> (affects hydrolysis).<br>
                - <b>Light (Photodegradation):</b> Rate adjusted by <b>${lightFactor.toFixed(1)}x</b>.<br>
                - <b>Oxidation:</b> Rate adjusted by <b>${oxidizerFactor.toFixed(1)}x</b>.<br>
                - <b>Metal Catalysis:</b> Rate adjusted by <b>${metalFactor.toFixed(1)}x</b> (affects oxidation).<br>
                - <b>Final Daily Degradation Rate (k): ${k_eff.toExponential(2)}</b>
            </small>`;

            infoP.innerHTML = summary;
            resultsDiv.style.display = 'block';
        }

        function runPreformulationAnalysis() {
            const dPka = parseFloat(document.getElementById('pka').value);
            const dMT = document.getElementById('molType').value;
            const dBS = parseFloat(document.getElementById('baseSol').value);
            const logP = parseFloat(document.getElementById('logP').value);
            const dd = parseFloat(document.getElementById('deltaD').value);
            const dp = parseFloat(document.getElementById('deltaP').value);
            const dh = parseFloat(document.getElementById('deltaH').value);
            const dR = parseFloat(document.getElementById('ra').value);
            const smiles = document.getElementById('smiles').value;
            
            if (isNaN(dPka) || isNaN(dBS) || isNaN(dd) || isNaN(dp) || isNaN(dh) || isNaN(dR) || dR <= 0 || isNaN(logP) || !smiles) {
                showDetStat('Please ensure all drug parameters (SMILES, pKa, S0, Log P, δD, δP, δH, R₀) are entered correctly. Use "Fetch & Predict" if needed.', 'error');
                return
            }
            
            structuralAnalysisResult = analyzeStructureForDegradation(smiles);
            const pathwayDiv = document.getElementById('pathwayResults');
            const pathwayInfo = document.getElementById('pathwayInfo');
            pathwayInfo.innerHTML = ''; // Clear previous results

            if(Object.keys(structuralAnalysisResult.pathways).length > 0) {
                let pathwayHTML = '';
                for(const pathwayName in structuralAnalysisResult.pathways) {
                    const pathwayData = structuralAnalysisResult.pathways[pathwayName];
                    let borderColor = 'border-gray-400';
                    let icon = '🔬';
                    if (pathwayName === 'Hydrolysis') { borderColor = '#3b82f6'; icon = '💧'; } /* blue-500 */
                    if (pathwayName === 'Oxidation') { borderColor = '#ef4444'; icon = '🔥'; } /* red-500 */
                    if (pathwayName === 'Photodegradation') { borderColor = '#eab308'; icon = '☀️'; } /* yellow-500 */
                    if (pathwayName === 'Metal-Catalyzed Oxidation') { borderColor = '#8b5cf6'; icon = '🔗'; } /* violet-500 */

                    pathwayHTML += `<div class="pathway-card" style="border-left-color: ${borderColor}">
                        <h4 class="text-lg font-bold text-slate-800 text-left mb-3 flex items-center"><span class="text-2xl mr-3">${icon}</span> ${pathwayName} Pathway</h4>
                        <p class="text-sm mb-2"><b>Vulnerable Groups Detected:</b> ${pathwayData.alerts.map(a => a.name).join(', ')}</p>
                        <p class="text-sm mb-3"><b>Potential Impurities:</b> ${[...new Set(pathwayData.alerts.map(a => a.products))].join(', ')}</p>
                        <h5 class="text-sm font-semibold mb-2">Generic Chemical Transformation:</h5>
                        <pre>${pathwayData.reactions.join('\n')}</pre>
                        <div class="impurity-structure">
                            <h5 class="text-sm font-semibold mb-2 text-left">Illustrative Impurity Formation:</h5>
                            <img src="${pathwayData.images[0]}" alt="Generic impurity structure" class="mx-auto">
                        </div>
                        <div class="deep-dive">
                            ${pathwayData.deepDives.join('<hr class="my-2">')}
                        </div>
                    </div>`;
                }
                pathwayInfo.innerHTML = pathwayHTML;
                pathwayDiv.style.display = 'block';
            } else {
                pathwayInfo.innerHTML = '<p>No common structural alerts for degradation were identified. The molecule appears relatively stable based on this simple analysis.</p>';
                pathwayDiv.style.display = 'block';
            }

            const pR = document.getElementById('phRange').value.split('-').map(Number);
            const cP = (pR[0] + pR[1]) / 2;
            
            const dHl = calcHildebrandDelta(dd, dp, dh);
            let sS = [];
            const pS = document.getElementById('solvents');
            Array.from(pS.selectedOptions).forEach(opt => {
                const sK = opt.value;
                if (solvents[sK]) {
                    sS.push(solvents[sK])
                }
            });
            document.querySelectorAll('#customSolventsContainer .custom-solvent-item').forEach(itm => {
                const n = itm.querySelector('.custom-name').value.trim();
                const cD = parseFloat(itm.querySelector('.custom-dd').value);
                const cP = parseFloat(itm.querySelector('.custom-dp').value);
                const cH = parseFloat(itm.querySelector('.custom-dh').value);
                if (n && !isNaN(cD) && !isNaN(cP) && !isNaN(cH)) {
                    sS.push({ name: n, dD: cD, dP: cP, dH: cH, molarVolume: 100 })
                }
            });
            if (sS.length === 0) {
                showDetStat('Please select or add at least one solvent.', 'warning');
                return
            }
            fullResults = [];
            let bR = Infinity;
            let bDH = Infinity;
            let bSR = [];
            let bSH = [];
            let bSF1 = null;
            let bSF2 = null;
            let bSF3 = null; 
            sS.forEach(s => {
                const R = calcHansenDist(dd, dp, dh, s.dD, s.dP, s.dH);
                const RED = R / dR;
                const sH = calcHildebrandDelta(s.dD, s.dP, s.dH);
                const dH = calcHildebrandDiff(dHl, sH);
                const pPAS = calcPkaPhSol(dBS, dPka, cP, dMT);
                const cS = pPAS / (1 + RED);
                const sWv = cS / 1e3 * 100;
                const iSH = RED <= 1;
                fullResults.push({ name: s.name, dD: s.dD, dP: s.dP, dH: s.dH, Ra: R, RED: RED, deltaHildebrand: dH, pkaPhAqueousSolubility: pPAS, combinedSolubility: cS, solubility_wv: sWv, isSolubleHansen: iSH });
                if (RED < bR) {
                    bSF3 = bSF2; 
                    bSF2 = bSF1; 
                    bR = RED;
                    bSF1 = s; 
                    bSR = [s.name];
                } else if (RED === bR) {
                    bSR.push(s.name);
                    if (bSF1 && s.name !== bSF1.name && (!bSF2 || RED < (calcHansenDist(dd, dp, dh, bSF2.dD, bSF2.dP, bSF2.dH) / dR))) {
                        bSF2 = s;
                    }
                } else if (bSF1 && (bSF2 === null || RED < (calcHansenDist(dd, dp, dh, bSF2.dD, bSF2.dP, bSF2.dH) / dR))) {
                    bSF3 = bSF2;
                    bSF2 = s;
                } else if (bSF1 && bSF2 && (bSF3 === null || RED < (calcHansenDist(dd, dp, dh, bSF3.dD, bSF3.dP, bSF3.dH) / dR))) {
                    bSF3 = s;
                }
                if (dH < bDH) {
                    bDH = dH;
                    bSH = [s.name]
                } else if (dH === bDH) {
                    bSH.push(s.name)
                }
            });

            fullResults.sort((a, b) => b.combinedSolubility - a.combinedSolubility);

            displayResults(fullResults, bSR, bSH);
            if (bSF1 && bSF2 && bSF1.name !== bSF2.name) {
                suggestBinaryBlend(dd, dp, dh, dR, bSF1, bSF2)
            } else {
                document.getElementById('binaryBlendSuggestion').style.display = 'none'
            }
            if (sS.length >= 3) {
                const sortedByRED = [...fullResults].sort((a, b) => a.RED - b.RED);
                if (sortedByRED.length >= 3) {
                    const top3SolventKeys = sortedByRED.slice(0, 3).map(s => s.name.toLowerCase().replace(/[^a-z0-9]/g, ''));
                    const top3Solvents = top3SolventKeys.map(key => Object.values(solvents).find(s => s.name.toLowerCase().replace(/[^a-z0-9]/g, '') === key)).filter(Boolean);

                    const distinctTop3 = [...new Map(top3Solvents.map(item => [item['name'], item])).values()];

                    if (distinctTop3.length >= 3) {
                        suggestTernaryBlend(dd, dp, dh, dR, distinctTop3[0], distinctTop3[1], distinctTop3[2]);
                    } else {
                        document.getElementById('ternaryBlendSuggestion').style.display = 'none';
                    }
                } else {
                    document.getElementById('ternaryBlendSuggestion').style.display = 'none';
                }
            } else {
                document.getElementById('ternaryBlendSuggestion').style.display = 'none';
            }
            plotResults(fullResults);
            calculateDegradation(structuralAnalysisResult);
        }

        function suggestBinaryBlend(dd, dp, dh, dR, s1, s2) {
            let bBR1 = 0;
            let mBR = Infinity;
            let bBS = 0;
            for (let i = 0; i <= 10; i++) {
                const f1 = i / 10;
                const f2 = 1 - f1;
                const bD = f1 * s1.dD + f2 * s2.dD;
                const bP = f1 * s1.dP + f2 * s2.dP;
                const bH = f1 * s1.dH + f2 * s2.dH;
                const RaB = calcHansenDist(dd, dp, dh, bD, bP, bH);
                const RB = RaB / dR;
                const dPka = parseFloat(document.getElementById('pka').value);
                const dMT = document.getElementById('molType').value;
                const dBS = parseFloat(document.getElementById('baseSol').value);
                const cP = parseFloat(document.getElementById('phRange').value.split('-').map(Number).reduce((a, b) => a + b) / 2);
                const pPAS = calcPkaPhSol(dBS, dPka, cP, dMT);
                const cSB = pPAS / (1 + RB);
                if (RB < mBR) {
                    mBR = RB;
                    bBR1 = f1;
                    bBS = cSB
                }
            }
            const bR1 = (100 * bBR1).toFixed(0);
            const bR2 = (100 - bR1).toFixed(0);
            const bRD = document.getElementById('blendResult');
            bRD.innerHTML = `An optimal blend of <b>${bR1}% ${s1.name}</b> and <b>${bR2}% ${s2.name}</b> yields a predicted RED of <b>${mBR.toFixed(2)}</b> and a combined solubility of <b>${bBS.toFixed(4)} mg/mL</b>.<br>This blend is likely to provide better solubility than individual components if RED is below 1.0.`;
            document.getElementById('binaryBlendSuggestion').style.display = 'block'
        }

        function suggestTernaryBlend(dd, dp, dh, dR, s1, s2, s3) {
            let bestBlendRatio1 = 0;
            let bestBlendRatio2 = 0;
            let minBlendRED = Infinity;
            let bestBlendSolubility = 0;

            const step = 0.1;

            for (let i = 0; i <= 10; i++) {
                const f1 = i * step;
                for (let j = 0; j <= 10; j++) {
                    const f2 = j * step;
                    const f3 = 1 - f1 - f2;

                    if (f1 >= -0.001 && f2 >= -0.001 && f3 >= -0.001 && Math.abs(f1 + f2 + f3 - 1) < 0.001) {
                        const blend_dD = f1 * s1.dD + f2 * s2.dD + f3 * s3.dD;
                        const blend_dP = f1 * s1.dP + f2 * s2.dP + f3 * s3.dP;
                        const blend_dH = f1 * s1.dH + f2 * s2.dH + f3 * s3.dH;

                        const Ra_blend = calcHansenDist(dd, dp, dh, blend_dD, blend_dP, blend_dH);
                        const RED_blend = Ra_blend / dR;

                        const dPka = parseFloat(document.getElementById('pka').value);
                        const dMT = document.getElementById('molType').value;
                        const dBS = parseFloat(document.getElementById('baseSol').value);
                        const cP = parseFloat(document.getElementById('phRange').value.split('-').map(Number).reduce((a, b) => a + b) / 2);

                        const pPAS = calcPkaPhSol(dBS, dPka, cP, dMT);
                        const cSB = pPAS / (1 + RED_blend);

                        if (RED_blend < minBlendRED) {
                            minBlendRED = RED_blend;
                            bestBlendRatio1 = f1;
                            bestBlendRatio2 = f2;
                            bestBlendSolubility = cSB;
                        }
                    }
                }
            }

            const bR1 = (bestBlendRatio1 * 100).toFixed(0);
            const bR2 = (bestBlendRatio2 * 100).toFixed(0);
            const bR3 = (100 - bR1 - bR2);

            const tBRD = document.getElementById('ternaryBlendSuggestion');
            tBRD.innerHTML = `
        An optimal ternary blend of <b>${bR1}% ${s1.name}</b>, <b>${bR2}% ${s2.name}</b>, and <b>${bR3.toFixed(0)}% ${s3.name}</b>
        yields a predicted RED of <b>${minBlendRED.toFixed(2)}</b> and a combined solubility of <b>${bestBlendSolubility.toFixed(4)} mg/mL</b>.
        <br>This blend is likely to provide better solubility than individual components if RED is below 1.0.
    `;
            document.getElementById('ternaryBlendSuggestion').style.display = 'block';
        }

        function displayResults(res, bRN, bHN) {
            const sCD = document.getElementById('solventCards');
            sCD.innerHTML = '';
            const productName = document.getElementById('productName').value.trim();
            const commonBestNames = bRN.filter(name => bHN.includes(name));

            res.forEach((r, index) => {
                const card = document.createElement('div');
                card.className = 'solvent-card';
                card.onclick = () => showDetails(res.findIndex(item => item.name === r.name));
                
                const compatibilityScore = Math.max(0, 100 - (r.RED * 50));
                let gaugeColor = 'bg-green-500';
                if (compatibilityScore < 75) gaugeColor = 'bg-yellow-500';
                if (compatibilityScore < 50) gaugeColor = 'bg-red-500';

                let statusTag = `<span class="font-bold text-green-600">GOOD</span>`;
                if (r.RED > 1.0) statusTag = `<span class="font-bold text-red-600">POOR</span>`;
                if (r.RED > 0.75 && r.RED <= 1.0) statusTag = `<span class="font-bold text-yellow-600">MARGINAL</span>`;

                let cardTitle = r.name;
                if (productName) cardTitle = `${productName} in ${r.name}`;

                if (bRN.includes(r.name)) card.classList.add('best');
                if (commonBestNames.includes(r.name)) card.classList.add('super-best');

                card.innerHTML = `
                    <div class="flex justify-between items-start mb-3">
                        <h4 class="text-lg font-bold text-slate-800 text-left">${cardTitle}</h4>
                        <div class="text-right">
                            <div class="text-xs font-bold text-slate-500">COMPATIBILITY</div>
                            <div class="text-lg font-bold ${gaugeColor.replace('bg-', 'text-')}">${compatibilityScore.toFixed(0)}%</div>
                        </div>
                    </div>
                    <div class="w-full gauge-bar-bg mb-4">
                        <div class="gauge-bar ${gaugeColor}" style="width: ${compatibilityScore}%;"></div>
                    </div>
                    <div class="text-sm space-y-2 flex-grow">
                        <div class="flex justify-between"><span>Hansen RED (Ra/R₀):</span> <span class="font-semibold">${r.RED.toFixed(2)}</span></div>
                        <div class="flex justify-between"><span>Hildebrand Δδ:</span> <span class="font-semibold">${r.deltaHildebrand.toFixed(2)} MPa¹/²</span></div>
                        <div class="flex justify-between"><span>Predicted Solubility:</span> <span class="font-semibold">${r.combinedSolubility.toFixed(4)} mg/mL</span></div>
                    </div>
                    <div class="mt-4 pt-3 border-t border-slate-200 text-center text-sm font-semibold">
                         Hansen Match: ${statusTag}
                    </div>
                `;
                sCD.appendChild(card);
            });

            const bSRD = document.getElementById('bestSolventsRecommendation');
            bSRD.innerHTML = ''; // Clear previous recommendations

            let recommendationHTML = '';
            if (bRN.length > 0) {
                const isSuperBest = commonBestNames.includes(bRN[0]);
                recommendationHTML += `
                    <div class="bg-white p-5 rounded-xl shadow-md border ${isSuperBest ? 'border-amber-400' : 'border-indigo-400'}">
                        <div class="flex items-center mb-2">
                             <span class="text-2xl mr-3">${isSuperBest ? '🏆' : '🎯'}</span>
                            <div>
                                <h4 class="font-bold text-slate-800">Top Pick (Hansen RED)</h4>
                                <p class="text-lg font-semibold text-indigo-600">${bRN.join(', ')}</p>
                            </div>
                        </div>
                        <p class="text-sm text-slate-600">Lowest RED value indicates the best solvent parameter match. Lower is better.</p>
                    </div>
                `;
            }
            if (bHN.length > 0) {
                 const isSuperBest = commonBestNames.includes(bHN[0]);
                 if(!commonBestNames.includes(bRN[0]) || bRN[0] !== bHN[0]) {
                    recommendationHTML += `
                        <div class="bg-white p-5 rounded-xl shadow-md border ${isSuperBest ? 'border-amber-400' : 'border-emerald-400'}">
                            <div class="flex items-center mb-2">
                                <span class="text-2xl mr-3">${isSuperBest ? '🏆' : '🌿'}</span>
                                <div>
                                    <h4 class="font-bold text-slate-800">Top Pick (Hildebrand Δδ)</h4>
                                    <p class="text-lg font-semibold text-emerald-600">${bHN.join(', ')}</p>
                                </div>
                            </div>
                            <p class="text-sm text-slate-600">Lowest Hildebrand difference indicates similar overall polarity. Lower is better.</p>
                        </div>
                    `;
                 }
            }
            
            if (commonBestNames.length === 0 && bRN.length > 0 && bHN.length > 0) {
                 recommendationHTML += `
                    <div class="md:col-span-2 bg-teal-50 border border-teal-200 text-teal-800 p-5 rounded-xl text-center">
                        <h4 class="font-bold mb-1">Synergy Alert: Consider Blending</h4>
                        <p class="text-sm">No single solvent is optimal by both principles. Consider using the <b>Optimal Binary/Ternary Blend Suggestions</b> below.</p>
                    </div>
                 `;
            }


            bSRD.innerHTML = recommendationHTML;
            document.getElementById('results').style.display = 'block'
        }

        function showDetails(index) {
            const result = fullResults[index];
            const drugD = parseFloat(document.getElementById('deltaD').value);
            const drugP = parseFloat(document.getElementById('deltaP').value);
            const drugH = parseFloat(document.getElementById('deltaH').value);
            const drugR0 = parseFloat(document.getElementById('ra').value);

            let summary;
            if (result.RED < 0.75) {
                summary = `<p class="text-green-700 bg-green-100 p-3 rounded-lg"><b>Assessment: Good Match.</b> The solvent's Hansen parameters are very close to the drug's, resulting in a low RED value. This indicates strong thermodynamic compatibility and a high likelihood of good solubility.</p>`;
            } else if (result.RED <= 1.0) {
                summary = `<p class="text-yellow-700 bg-yellow-100 p-3 rounded-lg"><b>Assessment: Marginal Match.</b> The solvent's parameters are reasonably close. It may work as a co-solvent but might not be an ideal primary solvent on its own.</p>`;
            } else {
                summary = `<p class="text-red-700 bg-red-100 p-3 rounded-lg"><b>Assessment: Poor Match.</b> There is a significant mismatch in Hansen parameters, leading to a high RED value. This solvent is unlikely to be effective for solubilizing the drug.</p>`;
            }

            const content = `
                <h3 class="text-xl font-bold text-slate-800 text-left mb-4">Justification for ${result.name}</h3>
                
                <h4 class="font-semibold mt-4 mb-2 text-left">1. Hansen Parameter Match (MPa¹/²)</h4>
                <div class="grid grid-cols-3 gap-4 text-center text-sm">
                    <div><span class="font-bold">δD (Dispersion)</span><br>${result.dD.toFixed(1)} vs ${drugD.toFixed(1)}</div>
                    <div><span class="font-bold">δP (Polar)</span><br>${result.dP.toFixed(1)} vs ${drugP.toFixed(1)}</div>
                    <div><span class="font-bold">δH (H-Bonding)</span><br>${result.dH.toFixed(1)} vs ${drugH.toFixed(1)}</div>
                </div>

                <h4 class="font-semibold mt-6 mb-2 text-left">2. RED Value Calculation</h4>
                <p class="text-sm">The Relative Energy Difference (RED) number quantifies the similarity between the drug and solvent. A value < 1.0 suggests high compatibility.</p>
                <div class="formula">RED = Ra / R₀ = ${result.Ra.toFixed(2)} / ${drugR0.toFixed(1)} = ${result.RED.toFixed(2)}</div>
                
                <h4 class="font-semibold mt-6 mb-2 text-left">3. Solubility Prediction</h4>
                <p class="text-sm">The final solubility is estimated by adjusting the drug's pH-dependent aqueous solubility (S_pH) by the RED value.</p>
                <div class="formula">S = S_pH / (1 + RED) = ${result.pkaPhAqueousSolubility.toFixed(4)} / (1 + ${result.RED.toFixed(2)}) = ${result.combinedSolubility.toFixed(4)} mg/mL</div>
                
                <h4 class="font-semibold mt-6 mb-2 text-left">4. Overall Assessment</h4>
                ${summary}
            `;
            
            document.getElementById('modalContent').innerHTML = content;
            document.getElementById('detailsModal').classList.add('visible');
        }

        function hideDetails() {
            document.getElementById('detailsModal').classList.remove('visible');
        }


        function plotResults(res) {
            const sN = res.map(r => r.name);
            const rV = res.map(r => r.RED);
            const cSV = res.map(r => Math.max(r.combinedSolubility, 1e-6));
            const tR = {
                x: sN,
                y: rV,
                name: 'RED (Hansen)',
                type: 'bar',
                marker: {
                    color: '#7c3aed' // violet-600
                }
            };
            const tS = {
                x: sN,
                y: cSV,
                name: 'Combined Solubility (mg/mL)',
                type: 'bar',
                marker: {
                    color: '#d946ef' // fuchsia-500
                },
                yaxis: 'y2'
            };
            const l = {
                title: 'Solvent Performance: RED vs. Combined Solubility',
                xaxis: {
                    title: 'Solvent'
                },
                yaxis: {
                    title: 'RED (Ra/R₀)'
                },
                yaxis2: {
                    title: 'Combined Solubility (mg/mL) (Log Scale)',
                    overlaying: 'y',
                    side: 'right',
                    type: 'log',
                    autorange: true
                },
                barmode: 'group',
                height: 400,
                margin: {
                    t: 40,
                    b: 40,
                    l: 40,
                    r: 40
                },
                paper_bgcolor: '#ffffff',
                plot_bgcolor: '#f5f3ff', /* violet-50 */
                font: {
                    family: 'Inter, sans-serif',
                    color: '#5b21b6' /* violet-800 */
                },
                responsive: true
            };
            Plotly.newPlot('chart', [tR, tS], l);
        }

        /***************************************************
         * FORMULATION DEVELOPMENT SCRIPTING STARTS HERE
         ***************************************************/

        function runFormulationAnalysis() {
            // Check for necessary inputs from pre-formulation
            const logP = parseFloat(document.getElementById('logP').value);
            const pka = parseFloat(document.getElementById('pka').value);
            const baseSol = parseFloat(document.getElementById('baseSol').value);
            const molarMass = parseFloat(document.getElementById('molarMass').value);
            const highestDose = parseFloat(document.getElementById('highestDose').value);

            if (isNaN(logP) || isNaN(pka) || isNaN(baseSol) || isNaN(molarMass) || isNaN(highestDose)) {
                showDetStat('Please ensure Drug Parameters (pKa, S0, LogP, Molar Mass) and Highest Dose are filled out before generating a strategy.', 'error');
                return;
            }
            
            if (!structuralAnalysisResult || Object.keys(structuralAnalysisResult).length === 0) {
                showDetStat('Please run the Pre-formulation Analysis first to generate critical stability and structural data.', 'warning');
                return;
            }

            document.getElementById('formulation-results').style.display = 'block';

            // Run all formulation recommendation functions
            const bcsClass = predictBCSAndBioavailability();
            predictDosageForm(bcsClass);
            recommendSolidState(bcsClass);
            checkExcipientCompatibility();
            assessProcessAndRegulatory();
        }

        function predictBCSAndBioavailability() {
            const highestDose = parseFloat(document.getElementById('highestDose').value);
            const baseSol = parseFloat(document.getElementById('baseSol').value);
            const logP = parseFloat(document.getElementById('logP').value);
            const molarMass = parseFloat(document.getElementById('molarMass').value);
            const recDiv = document.getElementById('bcsPrediction');

            // Solubility Class
            const doseNumber = highestDose / (baseSol * 250);
            const isSoluble = doseNumber <= 1;
            const solClass = isSoluble ? "High Solubility" : "Low Solubility";
            
            // Permeability Class (Lipinski's Rule of 5 proxy)
            const isPermeable = logP < 5 && molarMass < 500;
            const permClass = isPermeable ? "High Permeability" : "Low Permeability";

            let bcsClass = '';
            let bioavailability = '';
            let absorptionLimiations = '';

            if (isSoluble && isPermeable) {
                bcsClass = 'I';
                bioavailability = '> 90%';
                absorptionLimiations = 'None (Formulation-independent).';
            } else if (!isSoluble && isPermeable) {
                bcsClass = 'II';
                bioavailability = 'Variable (30-80%)';
                absorptionLimiations = 'Dissolution-rate limited.';
            } else if (isSoluble && !isPermeable) {
                bcsClass = 'III';
                bioavailability = '< 50%';
                absorptionLimiations = 'Permeability-rate limited.';
            } else {
                bcsClass = 'IV';
                bioavailability = '< 30%';
                absorptionLimiations = 'Both dissolution and permeability limited.';
            }
            
            recDiv.innerHTML = `
                <h4>BCS Classification: <span class="text-indigo-600 font-bold">Class ${bcsClass}</span></h4>
                <ul>
                    <li><b>Solubility Assessment:</b> ${solClass} (Dose Number: ${doseNumber.toFixed(2)})</li>
                    <li><b>Permeability Assessment:</b> ${permClass} (Based on LogP & MW)</li>
                </ul>
                <h4 class="mt-4">In-Silico Oral Bioavailability</h4>
                <ul>
                    <li><b>Predicted Oral Absorption:</b> <span class="risk-medium">${bioavailability}</span></li>
                    <li><b>Primary Absorption Limitation:</b> ${absorptionLimiations}</li>
                </ul>
            `;
            return bcsClass;
        }

        function showAndAnalyzeInjectableModule() {
            document.getElementById('injectable-specific-module').style.display = 'block';
            predictPrecipitationRisk();
        }

        function predictDosageForm(bcsClass) {
            const recDiv = document.getElementById('dosageFormRec');
            const { hasHydrolyticGroup, hasOxidativeGroup } = structuralAnalysisResult;
            let html = `<h4>Suggested Dosage Forms</h4><ul>`;
            let suggestions = new Set();

            // Oral Solids
            if (bcsClass === 'I' || bcsClass === 'III') suggestions.add('<li><span class="risk-low">Immediate-Release Tablet/Capsule:</span> High feasibility due to good aqueous solubility. Focus on standard granulation/compression.</li>');
            if (bcsClass === 'II') suggestions.add('<li><span class="risk-medium">Tablet/Capsule with Enabling Technology:</span> Required to overcome poor solubility. See solid-state recommendations below.</li>');
            
            // Liquids
            if (bcsClass === 'I' || bcsClass === 'III') suggestions.add('<li><span class="risk-low">Oral Solution/Suspension:</span> Good option for pediatric or geriatric populations. Ensure taste-masking.</li>');

            // Injectables
            suggestions.add(`<li><span class="risk-low">Injectable (IV/IM/SC):</span> A viable path, especially if oral bioavailability is low or immediate action is needed. <button id="showInjectableBtn" class="btn-small">Show Injectable Module</button></li>`);
            
            // Advanced/Alternative
            if (bcsClass === 'II' || bcsClass === 'IV') suggestions.add('<li><span class="risk-medium">Lipid-Based Formulation (e.g., SEDDS/SMEDDS):</span> Excellent for highly lipophilic drugs (LogP > 3) to improve absorption via lymphatic pathways.</li>');
            if (hasHydrolyticGroup || hasOxidativeGroup) suggestions.add('<li><span class="risk-medium">Lyophilized Powder for Reconstitution:</span> Strongly consider if drug is unstable in aqueous solution, to ensure long-term shelf stability.</li>');

            if (suggestions.size === 0) {
                 html += `<li>No standard dosage form is immediately obvious. This is typical for <span class="risk-high">BCS Class IV</span> drugs, requiring significant formulation work.</li>`;
            } else {
                suggestions.forEach(s => html += s);
            }

            html += `</ul>`;
            recDiv.innerHTML = html;
            // Add event listener after creating the button
            const btn = document.getElementById('showInjectableBtn');
            if(btn) btn.addEventListener('click', showAndAnalyzeInjectableModule);
        }

        function recommendSolidState(bcsClass) {
            const recDiv = document.getElementById('solidStateRec');
            let html = `<h4>Solid-State & Particle Engineering</h4><ul>`;

            if (bcsClass === 'II' || bcsClass === 'IV') {
                 html += `<li><span class="risk-medium">Particle Size Reduction (Micronization/Nanomilling):</span> Highly recommended to increase surface area and improve dissolution rate for this poorly soluble drug.</li>`;
                 html += `<li><span class="risk-high">Amorphous Solid Dispersion (ASD):</span> A key strategy. Consider formulating with polymers like <b>PVP, HPMC-AS, or Soluplus®</b> to create a high-energy amorphous state with enhanced solubility.</li>`;
                 html += `<li><span class="risk-medium">Co-amorphous or Co-crystal Formation:</span> An alternative approach to ASDs, potentially offering stability benefits. Requires specific screening.</li>`;
            } else {
                 html += `<li><span class="risk-low">Crystalline Form:</span> Standard crystalline form is preferred for stability and predictable manufacturing. Particle size reduction is likely not critical.</li>`;
            }
            html += `<li><b>Polymorph Screening:</b> Always recommended to identify the most stable crystalline form and avoid phase transformations during storage or processing.</li>`;
            html += `</ul>`;
            recDiv.innerHTML = html;
        }

        function checkExcipientCompatibility() {
            const recDiv = document.getElementById('excipientRec');
            const { functionalGroups } = structuralAnalysisResult;
            let html = `<h4>Excipient Interaction Risks</h4><ul>`;
            let risksFound = false;

            if (functionalGroups.hasPrimaryAmine || functionalGroups.hasSecondaryAmine) {
                html += `<li><span class="risk-high">Maillard Reaction Risk:</span> Drug contains an amine group. <b>Avoid reducing sugars</b> like Lactose, Dextrose. Prefer non-reactive fillers like <b>Microcrystalline Cellulose (MCC), Dibasic Calcium Phosphate, or Mannitol</b>.</li>`;
                risksFound = true;
            }
            if (structuralAnalysisResult.hasOxidativeGroup) {
                html += `<li><span class="risk-medium">Oxidative Degradation Risk:</span> Be cautious with excipients containing residual peroxides (e.g., <b>Povidone (PVP), Polysorbates</b>). Use low-peroxide grades or add antioxidants.</li>`;
                risksFound = true;
            }
             if (functionalGroups.hasEster) {
                html += `<li><span class="risk-medium">Transesterification/Hydrolysis Risk:</span> Avoid strongly acidic or basic excipients that could catalyze ester cleavage. Monitor compatibility with alcoholic or acidic excipients.</li>`;
                risksFound = true;
            }

            if (!risksFound) {
                 html += `<li><span class="risk-low">No major chemical incompatibility risks detected based on structure.</span> Standard excipient screening is still necessary.</li>`;
            }
            html += `</ul>`;
            recDiv.innerHTML = html;
        }

        function assessProcessAndRegulatory() {
            const processRecDiv = document.getElementById('processRec');
            const regulatoryRecDiv = document.getElementById('regulatoryRec');
            const { hasHydrolyticGroup, isPhotolabile, functionalGroups } = structuralAnalysisResult;
            const tempRange = document.getElementById('tempRange').value;
            let heatSensitive = tempRange.includes('80');

            // Process Recommendations
            let processHtml = `<h4>Processing Considerations</h4><ul>`;
            if (heatSensitive) processHtml += `<li><span class="risk-medium">Heat Sensitivity:</span> Avoid high temperatures during processing (e.g., drying). Target temperatures <b>below 40-50°C</b>.</li>`;
            if (hasHydrolyticGroup) processHtml += `<li><span class="risk-medium">Moisture Sensitivity:</span> Use controlled humidity environments during manufacturing. Consider dry granulation or direct compression for solid doses.</li>`;
            if (structuralAnalysisResult.hasOxidativeGroup) processHtml += `<li><span class="risk-medium">Oxygen Sensitivity:</span> Consider processing under a <b>nitrogen blanket</b> to prevent oxidative degradation.</li>`;
            processHtml += `<li><b>Sterilization (for Parenterals):</b> Based on heat sensitivity, ${heatSensitive ? '<span class="risk-high">Sterile Filtration</span> is likely required' : '<span class="risk-low">Terminal Sterilization (Autoclaving)</span> may be feasible'}.</li>`;
            processHtml += `</ul>`;
            processRecDiv.innerHTML = processHtml;

            // Regulatory Recommendations
            let regulatoryHtml = `<h4>Regulatory Risk Flags</h4><ul>`;
            if (isPhotolabile) regulatoryHtml += `<li><span class="risk-high">Photostability Risk:</span> ICH Q1B studies are mandatory. Requires light-protective primary and secondary packaging.</li>`;
            regulatoryHtml += `<li><span class="risk-medium">Polymorphism Risk:</span> High potential for multiple crystalline forms. Extensive polymorph screening and control are critical for regulatory submission.</li>`;
            if (functionalGroups.isGenotoxicRisk) regulatoryHtml += `<li><span class="risk-high">Potential Genotoxic Impurities:</span> Structure contains alerts for genotoxicity. Thorough impurity qualification (as per ICH M7) is essential.</li>`;
            else regulatoryHtml += `<li><span class="risk-low">Genotoxic Impurities:</span> No obvious structural alerts detected, but process-related impurities must still be evaluated.</li>`;
            regulatoryHtml += `<li><b>Residual Solvents:</b> Choice of solvents during synthesis and manufacturing must comply with ICH Q3C guidelines.</li>`;
            regulatoryHtml += `</ul>`;
            regulatoryRecDiv.innerHTML = regulatoryHtml;
        }
        
        function predictPrecipitationRisk() {
            const baseSol = parseFloat(document.getElementById('baseSol').value);
            const pka = parseFloat(document.getElementById('pka').value);
            const molType = document.getElementById('molType').value;
            const drugConc = parseFloat(document.getElementById('drugConcentration').value);
            const drugVolume = parseFloat(document.getElementById('drugVolume').value);
            const ivBagVolume = parseFloat(document.getElementById('ivBagVolume').value);
            const cosolventKey = document.getElementById('formulationCosolvent').value;
            const cosolventPercent = parseFloat(document.getElementById('cosolventPercent').value) / 100;

            if (isNaN(baseSol) || isNaN(pka) || isNaN(drugConc) || isNaN(drugVolume) || isNaN(ivBagVolume) || isNaN(cosolventPercent)) {
                document.getElementById('precipitationRiskRec').innerHTML = `<p class="risk-medium">Please ensure all drug and formulation parameters are entered correctly.</p>`;
                return;
            }
            
            const ivFluidSelect = document.getElementById('ivFluid');
            let ivFluidPh;

            if (ivFluidSelect.value === 'custom') {
                ivFluidPh = parseFloat(document.getElementById('customIvPh').value);
            } else {
                const selectedOptionText = ivFluidSelect.options[ivFluidSelect.selectedIndex].text;
                ivFluidPh = parseFloat(selectedOptionText.split('pH ~')[1].replace(')', ''));
            }
            
            if (isNaN(ivFluidPh)) {
                document.getElementById('precipitationRiskRec').innerHTML = `<p class="risk-medium">Invalid custom pH value.</p>`;
                return;
            }

            const recDiv = document.getElementById('precipitationRiskRec');

            // 1. Calculate final concentrations
            const totalVolume = drugVolume + ivBagVolume;
            const finalDrugConc = (drugConc * drugVolume) / totalVolume;
            const finalCosolventPercent = (cosolventPercent * drugVolume) / totalVolume;

            // 2. Predict solubility in the diluted vehicle using Yalkowsky-Roseman model
            const logSw = Math.log10(calcPkaPhSol(baseSol, pka, ivFluidPh, molType));
            
            let sigma = 0;
            if (cosolventKey !== 'none') {
                if (cosolventKey === 'custom') {
                    sigma = parseFloat(document.getElementById('customCosolventSigma').value) || 0;
                } else {
                    sigma = cosolventData[cosolventKey]?.sigma || 0;
                }
            }

            const logSmix = logSw + (sigma * finalCosolventPercent);
            const solInDilutedVehicle = Math.pow(10, logSmix);

            // 3. Calculate Supersaturation Index (SI)
            const SI = finalDrugConc / solInDilutedVehicle;

            let risk = 'LOW';
            let riskClass = 'risk-low';
            let kineticRisk = 'Precipitation is not expected as the solution remains undersaturated.';
            
            if (SI > 1) {
                if (SI > 5) {
                    risk = 'HIGH';
                    riskClass = 'risk-high';
                    kineticRisk = '<b>High supersaturation (SI > 5):</b> Rapid, uncontrolled precipitation is highly likely upon dilution. Formulation requires significant stabilization (e.g., precipitation inhibitors like HPMC, PVP) or reformulation.';
                } else {
                    risk = 'MEDIUM';
                    riskClass = 'risk-medium';
                    kineticRisk = '<b>Moderate supersaturation (1 < SI ≤ 5):</b> Risk of precipitation exists, potentially delayed. Formulation may benefit from precipitation inhibitors. Careful, slow dilution is critical.';
                }
            }
            
            let message = `
                <h4>Precipitation Risk Analysis: <span class="${riskClass}">${risk}</span></h4>
                <ul>
                    <li>Final Drug Concentration in IV Bag: <b>${finalDrugConc.toFixed(3)} mg/mL</b></li>
                    <li>Final Co-solvent Concentration in IV Bag: <b>${(finalCosolventPercent * 100).toFixed(2)}%</b></li>
                    <li>Predicted Drug Solubility in Diluted Vehicle (pH ${ivFluidPh}): <b class="${riskClass}">${solInDilutedVehicle.toFixed(3)} mg/mL</b></li>
                    <li class="mt-2"><b>Supersaturation Index (SI): <span class="text-2xl font-bold ${riskClass}">${SI.toFixed(2)}</span></b></li>
                </ul>
                <h4 class="mt-4">Kinetic Risk Assessment</h4>
                <p class="text-sm">${kineticRisk}</p>
                <p class="text-xs text-slate-500 mt-2">Note: Solubility in diluted vehicle is an estimate based on the Yalkowsky-Roseman log-linear model. Experimental verification is essential.</p>
            `;

            recDiv.innerHTML = message;
        }

        function exportToExcel() {
            const wb = XLSX.utils.book_new();
            const data = [];
            
            // --- Sheet 1: Summary ---
            data.push(["Parameter", "Value", "Comments"]);
            data.push(["Product Name", document.getElementById('productName').value]);
            data.push(["SMILES", document.getElementById('smiles').value]);
            data.push(["Molar Mass (g/mol)", document.getElementById('molarMass').value]);
            data.push(["pKa", document.getElementById('pka').value]);
            data.push(["Molecule Type", document.getElementById('molType').value]);
            data.push(["Log P", document.getElementById('logP').value]);
            data.push(["Base Solubility S₀ (mg/mL)", document.getElementById('baseSol').value]);
            
            // Add a separator
            data.push([]);
            data.push(["Formulation Strategy Summary"]);
            
            // BCS & Bioavailability
            const bcsText = document.getElementById('bcsPrediction').innerText.replace(/\n\n/g, '\n').split('\n');
            bcsText.forEach(line => data.push([line.split(':')[0], line.split(':')[1]]));
            
            // Dosage Form
            data.push([]);
            data.push(["Dosage Form Feasibility"]);
            const dosageText = document.getElementById('dosageFormRec').innerText.split('\n');
            dosageText.forEach(line => data.push([line]));

            // Solid State
            data.push([]);
            data.push(["Solid-State & Particle Engineering"]);
            const solidStateText = document.getElementById('solidStateRec').innerText.split('\n');
            solidStateText.forEach(line => data.push([line]));

            const ws = XLSX.utils.aoa_to_sheet(data);
            XLSX.utils.book_append_sheet(wb, ws, "Formulation Summary");

            // --- Sheet 2: Stability ---
            const stabilityData = [];
            stabilityData.push(["Degradation Pathway Analysis"]);
            const pathwayText = document.getElementById('pathwayInfo').innerText.split('\n');
            pathwayText.forEach(line => stabilityData.push([line]));
            
            stabilityData.push([]);
            stabilityData.push(["Quantitative Degradation Estimate"]);
            const degradationText = document.getElementById('degradationInfo').innerText.replace(/<br>/g, '\n').split('\n');
            degradationText.forEach(line => stabilityData.push([line]));

            const ws2 = XLSX.utils.aoa_to_sheet(stabilityData);
            XLSX.utils.book_append_sheet(wb, ws2, "Stability Assessment");

            // --- Sheet 3: Risk Assessment ---
            const riskData = [];
            riskData.push(["Excipient Compatibility Risks"]);
            const excipientText = document.getElementById('excipientRec').innerText.split('\n');
            excipientText.forEach(line => riskData.push([line]));
            
            riskData.push([]);
            riskData.push(["Process & Regulatory Risks"]);
            const processText = document.getElementById('processRec').innerText.split('\n');
            const regulatoryText = document.getElementById('regulatoryRec').innerText.split('\n');
            processText.forEach(line => riskData.push([line]));
            riskData.push([]);
            regulatoryText.forEach(line => riskData.push([line]));
            
            const ws3 = XLSX.utils.aoa_to_sheet(riskData);
            XLSX.utils.book_append_sheet(wb, ws3, "Risk Assessment");

            XLSX.writeFile(wb, `${document.getElementById('productName').value || 'Formulation_Report'}.xlsx`);
        }

    </script>
</body>

</html>
